<html>
<head><title>Websockets Chat Example</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
<style type="text/css">
 
 /*
<link href='http://fonts.googleapis.com/css?family=Ubuntu:300' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>

 */



	*:focus 
	{
    	outline: 0;
	}

	textarea:focus, input:focus
	{
    	outline: 0;
	}

 	html, body 
 	{
  		height: 100%;
    	margin: 0;
    	padding: 0;
    	overflow:hidden;
		/*font-family: 'Indie Flower', cursive;*/
		font-family: 'Droid Sans Mono',;
  		font-size: 14px;
  		text-shadow: 4px 4px 4px #aaa;
  		border:none;
    }

	.glass 
	{
	    background-color: white;
	    opacity: 0.4;
    	/*transform: translateY(-7rem);*/
	}

	.glass2 
	{
	    background-color: white;
	    opacity: 0.7;
    	/*transform: translateY(-7rem);*/
	}

	.glass_info 
	{
	    background-color: lightgray;
	    opacity: 0.3;
    	/*transform: translateY(-7rem);*/
	}

   	#fs_window 
   	{
   		min-height: 100%; 
   		min-width: 100%; 
		background: url("http://img.inspiringwallpapers.net/wp-content/uploads/2013/06/HD-wallpapers-beautiful-pictures-21761366-1920-12001.jpg") no-repeat center center fixed;
		background-size: 100%;
		-webkit-background-size: cover; /* For WebKit*/
    	-moz-background-size: cover;    /* Mozilla*/
    	-o-background-size: cover;      /* Opera*/
    	background-size: cover;         /* Generic*/   	
	}
	
	#fs_top
	{
   		clear:left;
   		float:left;
   		position: absolute;
  		min-width: 100%; 
  		padding: 0;
  		height:24px;
  		top:0px;
  		left:0px;
  		padding-top:4px;
		font-family: 'Droid Sans Mono',;
  		font-size: 16px;
  		color: #FEF4FF;
  		text-shadow: 3px 3px 3px #030303;
  		text-align: center;

		background: #edcbd5; /* Old browsers */
		background: -moz-linear-gradient(top, #edcbd5 0%, #da96a5 22%, #d07a8c 33%, #cb6b7e 50%, #c65c73 67%, #7f2f3e 82%, #091716 100%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#edcbd5), color-stop(22%,#da96a5), color-stop(33%,#d07a8c), color-stop(50%,#cb6b7e), color-stop(67%,#c65c73), color-stop(82%,#7f2f3e), color-stop(100%,#091716)); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top, #edcbd5 0%,#da96a5 22%,#d07a8c 33%,#cb6b7e 50%,#c65c73 67%,#7f2f3e 82%,#091716 100%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top, #edcbd5 0%,#da96a5 22%,#d07a8c 33%,#cb6b7e 50%,#c65c73 67%,#7f2f3e 82%,#091716 100%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top, #edcbd5 0%,#da96a5 22%,#d07a8c 33%,#cb6b7e 50%,#c65c73 67%,#7f2f3e 82%,#091716 100%); /* IE10+ */
		background: linear-gradient(to bottom, #edcbd5 0%,#da96a5 22%,#d07a8c 33%,#cb6b7e 50%,#c65c73 67%,#7f2f3e 82%,#091716 100%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#edcbd5', endColorstr='#091716',GradientType=0 ); /* IE6-9 */
	}
	
	#fs_users
	{
   		clear:left;
   		float:left;
   		position: absolute;
  		min-width: 8%; 
  		padding: 0;
  		height: -moz-calc(100% - 68px);
    	height: -webkit-calc(100% - 68px);
    	height: calc(100% - 68px);
  		top:32px;
  		right: 2px;
  		/*right:-14px;*/
  		padding-left:4px;
  		padding-right:4px;
  		padding-top: 4px;
  		margin-right: 4px;

  		opacity: 0.8;
		font-family: 'Droid Sans Mono',;
  		font-size: 16px;
  		color: GhostWhite ;
  		text-shadow: 3px 3px 3px #030303;
		line-height: 18px;


		background: rgb(125,126,125); /* Old browsers */
		background: -moz-linear-gradient(top, rgba(125,126,125,1) 0%, rgba(14,14,14,1) 100%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(125,126,125,1)), color-stop(100%,rgba(14,14,14,1))); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top, rgba(125,126,125,1) 0%,rgba(14,14,14,1) 100%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top, rgba(125,126,125,1) 0%,rgba(14,14,14,1) 100%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top, rgba(125,126,125,1) 0%,rgba(14,14,14,1) 100%); /* IE10+ */
		background: linear-gradient(to bottom, rgba(125,126,125,1) 0%,rgba(14,14,14,1) 100%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7d7e7d', endColorstr='#0e0e0e',GradientType=0 ); /* IE6-9 */
		padding: 4px;
		border: 3px solid darkgray;
		-moz-border-radius: 3px;
		-webkit-border-radius: 3px
	}

	#fs_info
	{
   		clear:left;
   		float:left;
   		position: absolute;
  		min-width: 100%; 
  		padding: 0;
  		height:24px;
  		top:0px;
  		left:0px;
  		padding-left:4px;

	}

	#fs_popup
	{
   		clear:left;
   		float:left;
   		position: absolute;
  		min-width: 100%; 
  		padding: 0;
  		height:24px;
  		top:0px;
  		left:0px;
  		padding-left:4px;
	}

	#fs_container
	{
   		overflow-y:auto;
		overflow-x:hidden;

   		background-color: transparent;
		border: none;
		width: 100%;
		height: 100%;
		-webkit-box-sizing: border-box;
     	-moz-box-sizing: border-box;
     	box-sizing: border-box;
     	position: absolute;
     	top: 16px;
     	left: 0px;
     	padding-left:12px;
     	padding-top:12px;
     	padding-bottom:12px;
     	padding-right:0px;

  		height: -moz-calc(100% - 28px);
    	height: -webkit-calc(100% - 28px);
    	height: calc(100% - 28px);
		background-size: 100%;

	}


   	#fs_chat
   	{
   		overflow-y:auto;
		overflow-x:hidden;

		border: none;

		white-space: pre-wrap;      /* CSS3 */   
	    white-space: -moz-pre-wrap; /* Firefox */    
	    white-space: -pre-wrap;     /* Opera <7 */   
	    white-space: -o-pre-wrap;   /* Opera 7 */    
	    word-wrap: break-word;      /* IE */

   		background-color: transparent;
		width: 90%;
		height: 100%;
		-webkit-box-sizing: border-box;
     	-moz-box-sizing: border-box;
     	box-sizing: border-box;
     	/*position: absolute;*/
     	/*top: 28px;*/
     	top: 0px;
     	left: 0px;
     	padding-left:8px;
     	padding-right:8px;
  		margin-right:12px;
     	/*padding-left:12px;
     	padding-top:12px;
     	padding-bottom:12px;

  		height: -moz-calc(100% - 56px);
    	height: -webkit-calc(100% - 56px);
    	height: calc(100% - 48px);
		background-size: 100%;
		*/
		font-family: 'Droid Sans Mono',;
  		font-size: 14px;
  		color: #FEF4FF;
  		text-shadow: 3px 3px 3px #030303;
		line-height: 1.2em;

		/*
   		background: #f8fdf8;
		padding: 0px;
		margin: 0px;
		width: 100%;
		height: 100%;
		-webkit-box-sizing: border-box;
     	-moz-box-sizing: border-box;
     	box-sizing: border-box;

  		height: -moz-calc(100% - 24px);
    	height: -webkit-calc(100% - 24px);
    	height: calc(100% - 24px);

		background: rgb(122,188,255); 
		background: -moz-linear-gradient(top,  rgba(122,188,255,1) 0%, rgba(96,171,248,1) 44%, rgba(64,150,238,1) 100%); 
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(122,188,255,1)), color-stop(44%,rgba(96,171,248,1)), color-stop(100%,rgba(64,150,238,1)));  Chrome,Safari4+ 
		background: -webkit-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(96,171,248,1) 44%,rgba(64,150,238,1) 100%); 
		background: -o-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(96,171,248,1) 44%,rgba(64,150,238,1) 100%); 
		background: -ms-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(96,171,248,1) 44%,rgba(64,150,238,1) 100%); 
		background: linear-gradient(to bottom,  rgba(122,188,255,1) 0%,rgba(96,171,248,1) 44%,rgba(64,150,238,1) 100%); 
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7abcff', endColorstr='#4096ee',GradientType=0 ); 
		*/
  /*background: -webkit-gradient(linear, center top, center bottom, color-stop(0%, #ccc), color-stop(100%, #efefef));
  background: -moz-linear-gradient(top, #ccc, #efefef);*/
   	}
   	#fs_input
   	{
   		clear:left;
   		float:left;
   		position: absolute;
  		min-width: 100%; 
  		padding: 0;
  		height:24px;
  		bottom:0px;
  		left:0px;
		background: rgb(122,188,255);
		background: -moz-linear-gradient(top,  rgba(122,188,255,1) 0%, rgba(49,148,247,1) 16%, rgba(96,171,248,1) 70%, rgba(64,150,238,1) 100%); 
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(122,188,255,1)), color-stop(16%,rgba(49,148,247,1)), color-stop(70%,rgba(96,171,248,1)), color-stop(100%,rgba(64,150,238,1)));
		background: -webkit-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: -o-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: -ms-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: linear-gradient(to bottom,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%);
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7abcff', endColorstr='#4096ee',GradientType=0 ); /* IE6-9 */
   	}
   	#chat_text
   	{
  		padding-left:4px;
  		padding-right:4px;
   		width: 100%;
   		height: 100%;
		/*background: rgb(122,188,255); */
		background: rgb(122,188,255);
		background: -moz-linear-gradient(top,  rgba(122,188,255,1) 0%, rgba(49,148,247,1) 16%, rgba(96,171,248,1) 70%, rgba(64,150,238,1) 100%); 
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(122,188,255,1)), color-stop(16%,rgba(49,148,247,1)), color-stop(70%,rgba(96,171,248,1)), color-stop(100%,rgba(64,150,238,1)));
		background: -webkit-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: -o-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: -ms-linear-gradient(top,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%); 
		background: linear-gradient(to bottom,  rgba(122,188,255,1) 0%,rgba(49,148,247,1) 16%,rgba(96,171,248,1) 70%,rgba(64,150,238,1) 100%);
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7abcff', endColorstr='#4096ee',GradientType=0 ); /* IE6-9 */
   	}

	textarea 
	{
		resize: none;
		/*font-family: 'Indie Flower', cursive;*/
		/*font-family: 'Ubuntu:300', cursive;*/
		font-family: 'Droid Sans Mono',;
  		font-size: 13px;
  		color: #FEF4FF;
  		text-shadow: 3px 3px 3px #030303;
    }

	input:focus
	{
    	outline: 0;
    	border: 0;
    	border-color: inherit;
  		-webkit-box-shadow: none;
  		box-shadow: none;
  		color: #FEF4FF;
    	/*font-family: 'Tangerine', serif;
  		font-size: 48px;
  		text-shadow: 4px 4px 4px #aaa;*/
	}

</style>
<!--[if lte IE 6]>
    <style type="text/css">
    	#container 
    	{
    		height: 100%;
    	}
    </style>
<![endif]-->

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>


<script type="text/javascript">
var connection;
var host="%SERVER_HOST%";
var port="%SERVER_PORT%";

var reconnect_timer = null;
var ping_timer = null;
var min_timeout = 10000;
var timeout_iteration = 1;
var reconnecting=false;





function get_timeout(iteration)
{
var rand = Math.round(Math.random() * 3000) + min_timeout * iteration;
return(rand);
}

function connect()
{
	connection = new WebSocket("ws://"+host+":"+port+"/", ["echo"]);
	connection.onopen = function () 
	{
 		timeout_iteration = 1;
		add_message("Connected to the server.");
		ping();
	};
	connection.onerror = function(error) 
	{
		//add_message("Error occured!");
		clearTimeout(ping_timer);
		add_message("Server offline!");
		reconnect();
	};
	connection.onclosed = function(error) 
	{
		clearTimeout(ping_timer);
		add_message("Connection Closed: "+error);
		reconnect();
	};
	connection.onmessage = function(e) 
	{
		add_message(e.data);
	};
}

function reconnect()
{
	ms = get_timeout(timeout_iteration++);
	add_message("Trying to reconnect in "+Math.round(ms/1000)+" seconds");
	clearTimeout(reconnect_timer);
	reconnect_timer = setTimeout(function() { reconnect_handler(); }, ms);	
}

function reconnect_handler()
{
	add_message("Reconnecting...");
	//reconnecting=false;
	connect();
}

function ping()
{
	clearTimeout(ping_timer);
	ping_timer=setTimeout(function() { ping_handler(); }, get_timeout(1));	
}

function ping_handler()
{
	if(connection.readyState==2 || connection.readyState==3)
	{
		add_message("Connection Closed.");
		reconnect();
	}
	else
	{
		connection.send("/ping");
		clearTimeout(ping_timer);
		ping_timer=setTimeout(function() { ping_handler(); }, get_timeout(1));	
	}
}

function verify_send(message)
{
	if(connection.readyState==2 || connection.readyState==3)
	{
		add_message("Connection Closed.");
		reconnect();
	}
	else
		connection.send(message);
}

function add_message(message)
{
	var cmd_nc = "/name_change";

	if(message.indexOf("/pong") == 0)
	{

	}
	else if(message.indexOf("/clear") == 0)
	{
		document.getElementById("fs_chat").innerHTML = "";
		var textarea = document.getElementById("fs_chat");
		textarea.scrollTop = textarea.scrollHeight;

	}
	else if(message.indexOf("/users") == 0)
	{
		var names = message.substring(6);
		var nlist = names.split(" ");
		var bg_div = document.getElementById("fs_window");
		var users = document.getElementById("fs_users");
		users.innerHTML = "";
		nlist.forEach(function(name) {
    		users.innerHTML = users.innerHTML +"<div id='user_"+name+"'>"+name+"</div>";	
		});		
		
	}
	else if(message.indexOf(cmd_nc) == 0)
	{
		var names = message.substring(13);
		var nlist = names.split(" ");
		var bg_div = document.getElementById("fs_window");
		var users = document.getElementById("fs_users");
		var src=nlist[0];
		var dst=nlist[1];
		var name_el = document.getElementById("user_"+src);
		name_el.innerHTML = dst;
		name_el.setAttribute("id","user_"+dst);
	}
	else if(message.indexOf("/join") == 0)
	{
		var name = message.substring(6);
		var bg_div = document.getElementById("fs_window");
		var users = document.getElementById("fs_users");
		users.innerHTML = users.innerHTML +"<div id='user_"+name+"'>"+name+"</div>";
	}
	else if(message.indexOf("/part") == 0)
	{
		var name = message.substring(6);
		var bg_div = document.getElementById("fs_window");
		//document.getElementById("fs_users").innerHTML = topic;
		var users = document.getElementById("fs_users");
		var name_el = document.getElementById("user_"+name);
		name_el.parentElement.removeChild(name_el);

	}
	else if(message.indexOf("/bg_url") == 0)
	{
		var url = message.substring(8);
		var bg_div = document.getElementById("fs_window");
	    bg_div.style.backgroundImage = "";
	    bg_div.style.backgroundImage = "url(" + url + ")";
		/*document.getElementById("fs_chat").style.visibility = "hidden"; 
	    alert("set bg:"+url);*/
	}
	else if(message.indexOf("/topic") == 0)
	{
		var topic = message.substring(7);
		var bg_div = document.getElementById("fs_window");
		document.getElementById("fs_top").innerHTML = topic;
	}
	else
	{
		document.getElementById("fs_chat").innerHTML = document.getElementById("fs_chat").innerHTML+"\n"+message;
		var textarea = document.getElementById("fs_chat");
		//$("#fs_chat").animate({ scrollBottom: 0 }, 500);
		textarea.scrollTop = textarea.scrollHeight;
		//$('fs_chat').scrollTop($('fs_chat').prop("scrollHeight"));
		
		/*var msg = new SpeechSynthesisUtterance(message);
		window.speechSynthesis.speak(msg);*/
	}
}


function send_message()
{
	var message = document.getElementById("chat_text").value;
	if(message.indexOf("/clear") != -1)
	{
		document.getElementById("fs_chat").innerHTML = "";
		//$("#fs_chat").animate({ scrollBottom: 0 }, 500);
		//$('fs_chat').scrollTop($('fs_chat').prop("scrollHeight"));
		var textarea = document.getElementById("fs_chat");
		textarea.scrollTop = textarea.scrollHeight;

	}
	else
		verify_send(message);
	document.getElementById("chat_text").value="";
}

function fix_focus()
{
	document.getElementById("chat_text").focus();
}

function setup()
{
	/*$(".nano").nanoScroller();*/

	fix_focus();
	document.addEventListener("keypress",function(e)
	{
    	if(e.keyCode==13)
    	{
        	/*document.getElementById("send_button").click();*/
    	    send_message();
	    }
	    else
	    {
	    	fix_focus();
	    }
	});

	document.addEventListener("keydown",function(e)
	{
    	fix_focus();
	});
	connect();
}


/*		<input id="send_button" type="submit" value="Send Message" onclick="send_message()">
    	<div id="fs_chat" onfocus="fix_focus()" tabindex="-1">Welcome to our Chat-Example Page</div>

  	<textarea id="fs_chat" onfocus="fix_focus()" tabindex="-1">Welcome to our anarcho chat (type /help for a list of commands)</textarea>

onfocus="fix_focus()"


		<div id="fs_users" onfocus="fix_focus()" tabindex="-1">USERS:<br>PEZ2001</div>
		<div id="fs_info" onfocus="fix_focus()" tabindex="-1">INFO TEXT</div>
		<div id="fs_popup" onfocus="fix_focus()" tabindex="-1">POPUP CONTENT</div>
class="glass down"
*/
</script>
</head>
<body onload="setup()">
    <div id="fs_window" onfocus="fix_focus()" tabindex="-1">
		<div id="fs_top" onfocus="fix_focus()" tabindex="-1" class="glass">Voyager Project Nyx Interpreter Demo</div>
		<div id="fs_users" onfocus="fix_focus()" tabindex="-1" class="glass_info"></div>
		<div id="fs_container" onkeypress="fix_focus()" tabindex="-1">
		<div id="fs_chat" onkeypress="fix_focus()" tabindex="-1" >Welcome to our anarchy chat (type /help for a list of commands)</div>
		</div>
		<div id="fs_input" onfocus="fix_focus()" tabindex="-1" class="glass2">
			<input id="chat_text" type="text" name="message" size="160" x-webkit-speech>
		</div>
	</div>
</body>
</html>